<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#5c94fc" />
  <title>Mini Mario</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" type="image/png" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; background: #5c94fc; overflow: hidden; }
    canvas { display: block; width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <audio id="bgm" src="bgm.mp3" autoplay loop></audio>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const player = { x: 50, y: 300, width: 30, height: 40, dx: 0, dy: 0, speed: 2, jumpPower: -6, grounded: false, alive: true };
    const gravity = 0.3;
    const keys = {};
    const platforms = [{ x: 0, y: 350, width: 800, height: 50 }, { x: 200, y: 280, width: 120, height: 10 }, { x: 400, y: 230, width: 100, height: 10 }];
    const enemies = [{ x: 300, y: 310, width: 30, height: 40, direction: -1, speed: 1 }, { x: 500, y: 190, width: 30, height: 40, direction: 1, speed: 1 }];
    const coins = [{ x: 220, y: 250, collected: false }, { x: 420, y: 200, collected: false }];
    let score = 0, lives = 3;

    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);

    function drawPlayer() {
      ctx.fillStyle = 'red';
      ctx.fillRect(player.x, player.y, player.width, player.height);
    }

    function drawPlatforms() {
      ctx.fillStyle = 'green';
      platforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));
    }

    function drawEnemies() {
      ctx.fillStyle = 'black';
      enemies.forEach(e => ctx.fillRect(e.x, e.y, e.width, e.height));
    }

    function drawCoins() {
      ctx.fillStyle = 'gold';
      coins.forEach(c => {
        if (!c.collected) {
          ctx.beginPath();
          ctx.arc(c.x, c.y, 8, 0, 2 * Math.PI);
          ctx.fill();
        }
      });
    }

    function drawScore() {
      ctx.fillStyle = 'white';
      ctx.font = '16px Arial';
      ctx.fillText(`Score: ${score}`, 10, 20);
      ctx.fillText(`Lives: ${lives}`, 10, 40);
    }

    function update() {
      if (!player.alive) return;

      if (keys['ArrowLeft']) player.dx = -player.speed;
      else if (keys['ArrowRight']) player.dx = player.speed;
      else player.dx = 0;

      if (keys[' '] && player.grounded) {
        player.dy = player.jumpPower;
        player.grounded = false;
      }

      player.dy += gravity;
      player.x += player.dx;
      player.y += player.dy;
      player.grounded = false;

      platforms.forEach(p => {
        if (player.x < p.x + p.width &&
            player.x + player.width > p.x &&
            player.y + player.height <= p.y + 10 &&
            player.y + player.height + player.dy >= p.y) {
          player.y = p.y - player.height;
          player.dy = 0;
          player.grounded = true;
        }
      });

      coins.forEach(c => {
        if (!c.collected && Math.abs(player.x + player.width / 2 - c.x) < 15 && Math.abs(player.y - c.y) < 30) {
          c.collected = true;
          score += 10;
        }
      });

      enemies.forEach(e => {
        e.x += e.speed * e.direction;
        if (e.x < 0 || e.x + e.width > canvas.width) e.direction *= -1;

        if (player.x < e.x + e.width && player.x + player.width > e.x && player.y < e.y + e.height && player.y + player.height > e.y) {
          lives--;
          if (lives <= 0) player.alive = false;
          else { player.x = 50; player.y = 300; player.dy = 0; }
        }
      });
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawPlatforms();
      drawCoins();
      drawEnemies();
      drawPlayer();
      drawScore();
      update();

      if (!player.alive) {
        ctx.fillStyle = 'white';
        ctx.font = '40px Arial';
        ctx.fillText('Game Over', canvas.width / 2 - 100, canvas.height / 2);
      } else {
        requestAnimationFrame(gameLoop);
      }
    }

    gameLoop();
  </script>
</body>
</html>